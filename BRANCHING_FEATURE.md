# Chat Branching Feature

## Overview
The chat branching feature allows you to fork a conversation from any message, keeping the preceding context and continuing with a model you choose at branch time.

## How to Use

### 1. **Opening the Branch Dialog**
- Hover over any message in the chat (user or assistant message)
- A toolbar will appear above/below the message
- Click the **"Branch"** button (arrow triangle fork icon)

### 2. **Selecting AI Model**
- A modal dialog opens titled "Create Branch"
- The dialog shows:
  - The source message you're branching from
  - A dropdown menu to select an AI model/provider
  - Create/Cancel buttons

- Click the model selector to see all available AI models
- Models are organized by provider (e.g., "OpenAI - GPT-4", "Claude - 3.5")
- Select the model you want to use for the branch

### 3. **Auto-Generation**
- For **user branches**: A new conversation will be automatically created with:
  - All messages up to and including your selected message
  - The new model immediately generating a response
  
- For **assistant branches**: A new conversation will be created with:
  - All messages up to and including the assistant response
  - Ready for you to type the next user message

### 4. **Visual Indicators**
- **Sidebar**: Branched chats show a small **tuning fork icon** next to the provider logo
- **Chat List**: Branched chats have the original chat name with " (Branch)" appended
- **Parent-Child Relationships**: The branch tree structure is maintained in Core Data

## Technical Details

### Data Model
The feature adds the following to `ChatEntity`:
- `parentChat`: Reference to the source chat
- `childChats`: All branches created from this chat
- `branchSourceMessageID`: The ID of the message that was branched from
- `branchSourceRole`: Whether the branch origin was "user" or "assistant"
- `branchRootID`: Groups all descendants under the original chat

### Message Provider Metadata
Every assistant message now stores:
- `agentServiceName`: The AI service used (e.g., "OpenAI")
- `agentServiceType`: Service type (e.g., "openai")
- `agentModel`: The specific model (e.g., "gpt-4-turbo")

This ensures historical accuracy - if you branch from an old message that was generated by Claude but later switch to GPT-4, the branch will correctly show that the old message used Claude.

### Implementation Flow

1. **User clicks Branch button** → Opens BranchCreationSheet
2. **User selects model** → ChatBranchingManager.createBranchAsync() runs
3. **ChatBranchingManager**:
   - Creates new ChatEntity
   - Copies messages up to branch point
   - Rebuilds request messages
   - Posts OpenChatByID notification
   - For user branches: auto-generates response via MessageManager
4. **ContentView listens** for notification and selects the new chat
5. **New chat opens** in the chat view with the branched conversation

## UI/UX Features
- **Clean Dialog**: Simple model selector without unnecessary options
- **Auto-naming**: Branch names are auto-generated as "{Original Name} (Branch)"
- **Async/Await**: Uses modern Swift concurrency (no hanging)
- **Error Handling**: Shows clear error messages if something fails
- **Loading State**: Progress indicator while branch is being created

## Known Limitations
- Branch names cannot be customized (auto-generated)
- Cannot manually select multiple models at once
- Branches are one-level deep (no branching of branches, but data model supports it)

## Future Enhancements
- Custom branch naming
- Branch grouping/visualization
- Bulk branch operations
- Branch merging/comparison
